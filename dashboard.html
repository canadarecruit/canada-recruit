<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tableau de bord Admin - Ajouts</title>
    <meta name="description" content="Tableau de bord administrateur pour gérer les offres d'emploi et les paiements">
    
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    
    <style>
        :root {
            --primary-color: #0d6efd;
            --secondary-color: #6c757d;
            --success-color: #198754;
            --danger-color: #dc3545;
        }
        
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .navbar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .navbar-brand {
            font-weight: 700;
            font-size: 1.5rem;
        }
        
        .container-main {
            padding-top: 2rem;
            padding-bottom: 2rem;
        }
        
        .form-card, .list-card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            padding: 2rem;
            margin-bottom: 2rem;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .form-card:hover, .list-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
        }
        
        .form-card h2, .list-card h2 {
            color: #667eea;
            font-weight: 700;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .form-label {
            font-weight: 600;
            color: #495057;
            margin-bottom: 0.5rem;
        }
        
        .form-control, .form-select {
            border-radius: 8px;
            border: 2px solid #e9ecef;
            padding: 0.75rem;
            transition: all 0.3s ease;
        }
        
        .form-control:focus, .form-select:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        }
        
        .btn-submit {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 8px;
            padding: 0.75rem 2rem;
            font-weight: 600;
            color: white;
            transition: all 0.3s ease;
            width: 100%;
        }
        
        .btn-submit:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .btn-logout {
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid white;
            border-radius: 8px;
            padding: 0.5rem 1.5rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .btn-logout:hover {
            background: white;
            color: #667eea;
        }
        
        .btn-refresh {
            background: linear-gradient(135deg, #198754 0%, #20c997 100%);
            border: none;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            transition: all 0.3s ease;
        }
        
        .btn-refresh:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(25, 135, 84, 0.4);
        }
        
        .btn-delete {
            background: var(--danger-color);
            border: none;
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 5px;
            font-size: 0.875rem;
        }
        
        .btn-delete:hover {
            background: #c82333;
        }
        
        .alert {
            border-radius: 10px;
            border: none;
        }
        
        .footer {
            background: white;
            padding: 1.5rem 0;
            margin-top: 3rem;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
        }
        
        .required-field::after {
            content: " *";
            color: var(--danger-color);
        }
        
        textarea.form-control {
            min-height: 100px;
            resize: vertical;
        }
        
        .form-check-input:checked {
            background-color: #667eea;
            border-color: #667eea;
        }
        
        .table {
            font-size: 0.9rem;
        }
        
        .table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #495057;
        }
        
        .table td {
            vertical-align: middle;
        }
        
        .no-data {
            text-align: center;
            color: #6c757d;
            font-style: italic;
            padding: 2rem;
        }
        
        .spinner-border-sm {
            width: 1rem;
            height: 1rem;
        }
        
        .featured-yes {
            color: #ffc107;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-dark">
        <div class="container-fluid">
            <span class="navbar-brand">
                <i class="bi bi-speedometer2"></i> Tableau de bord Admin - Ajouts
            </span>
            <button class="btn btn-logout text-white" id="logoutBtn">
                <i class="bi bi-box-arrow-right"></i> Déconnexion
            </button>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container container-main">
        <!-- Alert Container -->
        <div id="alertContainer"></div>

        <!-- Job Offer Form -->
        <div class="form-card">
            <h2>
                <i class="bi bi-briefcase-fill"></i>
                Ajouter une offre d'emploi
            </h2>
            <form id="jobOfferForm">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="jobTitle" class="form-label required-field">Titre de l'offre</label>
                        <input type="text" class="form-control" id="jobTitle" placeholder="Ex: Développeur Full Stack" required>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="jobCompany" class="form-label required-field">Entreprise</label>
                        <input type="text" class="form-control" id="jobCompany" placeholder="Ex: TechCorp" required>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="jobLocation" class="form-label required-field">Localisation</label>
                        <input type="text" class="form-control" id="jobLocation" placeholder="Ex: Paris, France" required>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="jobType" class="form-label">Type de contrat</label>
                        <select class="form-select" id="jobType">
                            <option value="">Sélectionner un type</option>
                            <option value="full-time">Temps plein</option>
                            <option value="part-time">Temps partiel</option>
                            <option value="contract">Contrat</option>
                            <option value="internship">Stage</option>
                        </select>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label for="jobSalary" class="form-label">Salaire (CAD)</label>
                        <input type="text" class="form-control" id="jobSalary" placeholder="Ex: 45000 - 60000">
                    </div>
                    <div class="col-md-4 mb-3">
                        <label for="jobCategory" class="form-label">Catégorie</label>
                        <select class="form-select" id="jobCategory">
                            <option value="">Sélectionner une catégorie</option>
                            <option value="IT">IT / Informatique</option>
                            <option value="Marketing">Marketing</option>
                            <option value="Sales">Ventes / Commerce</option>
                            <option value="Finance">Finance</option>
                            <option value="HR">Ressources Humaines</option>
                            <option value="Operations">Opérations</option>
                            <option value="Santé">Santé</option>
                            <option value="Ingénierie">Ingénierie</option>
                            <option value="Restauration">Restauration</option>
                            <option value="Other">Autre</option>
                        </select>
                    </div>
                    <div class="col-md-4 mb-3">
                        <label class="form-label">&nbsp;</label>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="jobFeatured">
                            <label class="form-check-label" for="jobFeatured">
                                <i class="bi bi-star-fill"></i> Offre vedette
                            </label>
                        </div>
                    </div>
                </div>

                <div class="mb-3">
                    <label for="jobDescription" class="form-label">Description</label>
                    <textarea class="form-control" id="jobDescription" placeholder="Décrivez l'offre d'emploi..."></textarea>
                </div>

                <div class="mb-3">
                    <label for="jobRequirements" class="form-label">Exigences</label>
                    <textarea class="form-control" id="jobRequirements" placeholder="Listez les exigences pour ce poste..."></textarea>
                </div>

                <button type="submit" class="btn btn-submit">
                    <i class="bi bi-plus-circle"></i> Créer l'offre d'emploi
                </button>
            </form>
        </div>

        <!-- Payment Form -->
        <div class="form-card">
            <h2>
                <i class="bi bi-credit-card-fill"></i>
                Ajouter un paiement
            </h2>
            <form id="paymentForm">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="paymentUserId" class="form-label required-field">Utilisateur</label>
                        <select class="form-select" id="paymentUserId" required>
                            <option value="">Sélectionner un utilisateur</option>
                        </select>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="paymentDescription" class="form-label required-field">Description</label>
                        <input type="text" class="form-control" id="paymentDescription" placeholder="Ex: Abonnement mensuel" required>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label for="paymentAmount" class="form-label required-field">Montant</label>
                        <input type="number" class="form-control" id="paymentAmount" placeholder="Ex: 99.99" required min="0.01" step="0.01">
                    </div>
                    <div class="col-md-4 mb-3">
                        <label for="paymentCurrency" class="form-label required-field">Devise</label>
                        <input type="text" class="form-control" id="paymentCurrency" placeholder="Ex: CAD" required maxlength="3" value="CAD">
                    </div>
                    <div class="col-md-4 mb-3">
                        <label for="paymentStatus" class="form-label">Statut</label>
                        <select class="form-select" id="paymentStatus">
                            <option value="pending">En attente</option>
                            <option value="paid">Payé</option>
                        </select>
                    </div>
                </div>

                <button type="submit" class="btn btn-submit">
                    <i class="bi bi-plus-circle"></i> Créer le paiement
                </button>
            </form>
        </div>

        <!-- Job Offers List -->
        <div class="list-card">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h2>
                    <i class="bi bi-list-ul"></i>
                    Liste des offres d'emploi
                </h2>
                <button class="btn btn-refresh" id="refreshJobsBtn">
                    <i class="bi bi-arrow-clockwise"></i> Actualiser
                </button>
            </div>
            <div id="jobsList">
                <div class="no-data">Chargement des offres...</div>
            </div>
        </div>

        <!-- Payments List -->
        <div class="list-card">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h2>
                    <i class="bi bi-list-ul"></i>
                    Liste des paiements
                </h2>
                <button class="btn btn-refresh" id="refreshPaymentsBtn">
                    <i class="bi bi-arrow-clockwise"></i> Actualiser
                </button>
            </div>
            <div id="paymentsList">
                <div class="no-data">Chargement des paiements...</div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <div class="container text-center text-muted">
            <p class="mb-0">&copy; 2025 Tableau de bord Admin. Tous droits réservés.</p>
        </div>
    </footer>

    <!-- Bootstrap 5 JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Custom JavaScript -->
    <script>
        // Configuration
        const API_BASE_URL = 'https://canadarecruit.vercel.app/api';
        const TOKEN_KEY = 'token'; // Assume token is stored under this key

        // Check token on load
        

        // Alert display function
        function showAlert(message, type = 'success') {
            const alertContainer = document.getElementById('alertContainer');
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
            alertDiv.role = 'alert';
            alertDiv.innerHTML = `
                <i class="bi bi-${type === 'success' ? 'check-circle' : 'exclamation-triangle'}-fill"></i>
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            alertContainer.appendChild(alertDiv);

            // Auto-remove after 5 seconds
            setTimeout(() => {
                alertDiv.remove();
            }, 5000);

            // Scroll to alert
            alertDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        // Generic API request function
        async function apiRequest(endpoint, options = {}) {
            const token = localStorage.getItem(TOKEN_KEY);
            
            const config = {
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                ...options
            };

            try {
                const response = await fetch(`${API_BASE_URL}${endpoint}`, config);
                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.error || result.message || `Erreur ${response.status}: ${response.statusText}`);
                }

                return result;
            } catch (error) {
                if (error.message.includes('Failed to fetch')) {
                    throw new Error('Impossible de se connecter au serveur. Vérifiez que l\'API est en cours d\'exécution.');
                }
                throw error;
            }
        }

        // Generic API POST function
        async function apiPost(endpoint, data) {
            return apiRequest(endpoint, {
                method: 'POST',
                body: JSON.stringify(data)
            });
        }

        // Generic API DELETE function
        async function apiDelete(endpoint, id) {
            return apiRequest(endpoint, {
                method: 'DELETE',
                body: JSON.stringify({ id })
            });
        }

        // Load Users for Payment Form
        async function loadUsers() {
            try {
                const response = await apiRequest('/users');
                const users = response.users || []; // Assume response structure: {users: [...]}

                const select = document.getElementById('paymentUserId');
                select.innerHTML = '<option value="">Sélectionner un utilisateur</option>';
                users.forEach(user => {
                    const option = document.createElement('option');
                    option.value = user.id;
                    option.textContent = `${user.firstName} ${user.lastName}`;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Erreur lors du chargement des utilisateurs:', error);
                showAlert(`Erreur lors du chargement des utilisateurs: ${error.message}`, 'danger');
            }
        }

        // Function to render jobs table
        function renderJobsTable(containerId, data) {
            const container = document.getElementById(containerId);
            if (!data || data.length === 0) {
                container.innerHTML = '<div class="no-data">Aucune offre d\'emploi trouvée.</div>';
                return;
            }

            let tableHTML = `
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Titre</th>
                                <th>Entreprise</th>
                                <th>Localisation</th>
                                <th>Type</th>
                                <th>Salaire</th>
                                <th>Catégorie</th>
                                <th>Vedette</th>
                                <th>Date de publication</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            data.forEach(item => {
                const featuredText = item.featured == 1 ? '<span class="featured-yes">Oui</span>' : 'Non';
                const salaryText = item.salary || '-';
                const postedDate = new Date(item.posted).toLocaleDateString('fr-CA');
                const row = `
                    <tr>
                        <td><strong>${item.id}</strong></td>
                        <td>${item.title || '-'}</td>
                        <td>${item.company || '-'}</td>
                        <td>${item.location || '-'}</td>
                        <td>${item.type || '-'}</td>
                        <td>${salaryText}</td>
                        <td>${item.category || '-'}</td>
                        <td>${featuredText}</td>
                        <td>${postedDate}</td>
                        <td>
                            <button class="btn btn-delete btn-sm" onclick="deleteItem(${item.id}, '/job_offers')">
                                <i class="bi bi-trash"></i> Supprimer
                            </button>
                        </td>
                    </tr>
                `;
                tableHTML += row;
            });

            tableHTML += `
                        </tbody>
                    </table>
                </div>
            `;

            container.innerHTML = tableHTML;
        }

        // Function to render payments table
        function renderPaymentsTable(containerId, data) {
            const container = document.getElementById(containerId);
            if (!data || data.length === 0) {
                container.innerHTML = '<div class="no-data">Aucun paiement trouvé.</div>';
                return;
            }

            let tableHTML = `
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Nom Utilisateur</th>
                                <th>Description</th>
                                <th>Montant</th>
                                <th>Devise</th>
                                <th>Statut</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            data.forEach(item => {
                const amountNum = parseFloat(item.amount) || 0;
                const amountText = item.amount ? `${amountNum.toFixed(2)} ${item.currency}` : '-';
                const statusBadge = item.status === 'paid' ? 
                    '<span class="badge bg-success">Payé</span>' : 
                    '<span class="badge bg-warning">En attente</span>';
                const row = `
                    <tr>
                        <td><strong>${item.id}</strong></td>
                        <td>${item.user_name || '-'}</td>
                        <td>${item.description || '-'}</td>
                        <td>${amountText}</td>
                        <td>${item.currency || '-'}</td>
                        <td>${statusBadge}</td>
                        <td>
                            <button class="btn btn-delete btn-sm" onclick="deleteItem(${item.id}, '/payments')">
                                <i class="bi bi-trash"></i> Supprimer
                            </button>
                        </td>
                    </tr>
                `;
                tableHTML += row;
            });

            tableHTML += `
                        </tbody>
                    </table>
                </div>
            `;

            container.innerHTML = tableHTML;
        }

        // Global delete function
        async function deleteItem(id, endpoint) {
            if (!confirm('Êtes-vous sûr de vouloir supprimer cet élément ?')) return;

            try {
                const result = await apiDelete(endpoint, id);
                showAlert('Élément supprimé avec succès !', 'success');
                // Refresh lists
                loadJobOffers();
                loadPayments();
            } catch (error) {
                console.error('Erreur lors de la suppression:', error);
                showAlert(`Erreur: ${error.message}`, 'danger');
            }
        }

        // Load Job Offers
        async function loadJobOffers() {
            try {
                const jobsContainer = document.getElementById('jobsList');
                jobsContainer.innerHTML = '<div class="text-center"><div class="spinner-border" role="status"><span class="visually-hidden">Chargement...</span></div></div>';

                const response = await apiRequest('/job_offers');
                const jobs = response.job_offers || [];

                renderJobsTable('jobsList', jobs);
            } catch (error) {
                console.error('Erreur lors du chargement des offres:', error);
                document.getElementById('jobsList').innerHTML = `<div class="no-data text-danger">Erreur: ${error.message}</div>`;
            }
        }

        // Load Payments
        async function loadPayments() {
            try {
                const paymentsContainer = document.getElementById('paymentsList');
                paymentsContainer.innerHTML = '<div class="text-center"><div class="spinner-border" role="status"><span class="visually-hidden">Chargement...</span></div></div>';

                const response = await apiPost('/payments/all', {});
                const payments = response.payments || [];

                renderPaymentsTable('paymentsList', payments);
            } catch (error) {
                console.error('Erreur lors du chargement des paiements:', error);
                document.getElementById('paymentsList').innerHTML = `<div class="no-data text-danger">Erreur: ${error.message}</div>`;
            }
        }

        // Job Offer Form Handler (assuming POST /job_offers)
        document.getElementById('jobOfferForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const jobData = {
                title: document.getElementById('jobTitle').value.trim(),
                company: document.getElementById('jobCompany').value.trim(),
                location: document.getElementById('jobLocation').value.trim(),
                type: document.getElementById('jobType').value || undefined,
                salary: document.getElementById('jobSalary').value.trim() || undefined,
                category: document.getElementById('jobCategory').value || undefined,
                featured: document.getElementById('jobFeatured').checked ? 1 : 0,
                description: document.getElementById('jobDescription').value.trim() || undefined,
                requirements: document.getElementById('jobRequirements').value.trim() || undefined
            };

            // Remove undefined values
            Object.keys(jobData).forEach(key => jobData[key] === undefined && delete jobData[key]);

            try {
                const submitBtn = e.target.querySelector('button[type="submit"]');
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Création en cours...';

                const result = await apiPost('/job_offers', jobData);
                
                showAlert(`✓ Offre d'emploi créée avec succès ! ID: ${result.job_offer_id}`, 'success');
                e.target.reset();
                loadJobOffers(); // Refresh list
            } catch (error) {
                console.error('Erreur lors de la création de l\'offre:', error);
                showAlert(`✗ Erreur: ${error.message}`, 'danger');
            } finally {
                const submitBtn = e.target.querySelector('button[type="submit"]');
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="bi bi-plus-circle"></i> Créer l\'offre d\'emploi';
            }
        });

        // Payment Form Handler (assuming POST /payments)
        document.getElementById('paymentForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const userId = document.getElementById('paymentUserId').value;
            if (!userId) {
                showAlert('Veuillez sélectionner un utilisateur', 'warning');
                return;
            }

            const paymentData = {
                user_id: parseInt(userId),
                description: document.getElementById('paymentDescription').value.trim(),
                amount: parseFloat(document.getElementById('paymentAmount').value),
                currency: document.getElementById('paymentCurrency').value.trim().toUpperCase(),
                status: document.getElementById('paymentStatus').value
            };

            // Validation
            if (paymentData.amount <= 0) {
                showAlert('Le montant doit être supérieur à 0', 'warning');
                return;
            }

            if (paymentData.currency.length !== 3) {
                showAlert('La devise doit être un code à 3 lettres (ex: CAD, USD)', 'warning');
                return;
            }

            try {
                const submitBtn = e.target.querySelector('button[type="submit"]');
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Création en cours...';

                const result = await apiPost('/payments', paymentData);
                
                showAlert(`✓ Paiement créé avec succès ! ID: ${result.payment_id}`, 'success');
                e.target.reset();
                // Reset to default values
                document.getElementById('paymentCurrency').value = 'CAD';
                document.getElementById('paymentStatus').value = 'pending';
                loadPayments(); // Refresh list
            } catch (error) {
                console.error('Erreur lors de la création du paiement:', error);
                showAlert(`✗ Erreur: ${error.message}`, 'danger');
            } finally {
                const submitBtn = e.target.querySelector('button[type="submit"]');
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="bi bi-plus-circle"></i> Créer le paiement';
            }
        });

        // Currency field uppercase converter
        document.getElementById('paymentCurrency').addEventListener('input', (e) => {
            e.target.value = e.target.value.toUpperCase();
        });

        // Logout Handler
        

        // Refresh Buttons
        document.getElementById('refreshJobsBtn').addEventListener('click', loadJobOffers);
        document.getElementById('refreshPaymentsBtn').addEventListener('click', loadPayments);

        // Load lists on page load
        window.addEventListener('load', () => {
            loadUsers();
            loadJobOffers();
            loadPayments();
        });
    </script>
</body>
</html>